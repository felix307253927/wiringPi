<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>client</title>
</head>
<body>
speed <input id="speed" type="number" value="0">
w a s d 方向 - +

<script src="socket.io_client.js"></script>
<script>
  let sp   = document.getElementById('speed')
  const ws = io.connect('ws://192.168.6.155:8086')
  //  const ws = io.connect('ws://192.168.1.109:8086')
  //  const ws = io.connect('ws://192.168.1.109:8086')
  //  const ws             = io.connect('ws://192.168.1.108:8086')
  let _timer, speed = 0, keyPress = {}, lastMotorCmd = '', lastCameraCmd = '';

  function getMotorCmd() {
    let cmd = '';
    if (keyPress[87]) {
      cmd = 'F'
    } else if (keyPress[83]) {
      cmd = 'B'
    }
    if (keyPress[65]) {
      cmd += 'L'
    } else if (keyPress[68]) {
      cmd += 'R'
    }
    return cmd
  }

  function getCameraCmd() {
    let cmd = '';
    switch (true) {
      case keyPress[37]:
        cmd = 'L';
        break;
      case keyPress[38]:
        cmd = 'U';
        break;
      case keyPress[39]:
        cmd = 'R';
        break;
      case keyPress[40]:
        cmd = 'D';
        break;
    }
    return cmd;
  }

  function stop(type) {
    if (!type) {
      for (let k in keyPress) {
        keyPress[k] = false;
      }
      ws.emit('motor', 'stop')
      ws.emit('camera', 'stop')
    }
  }

  ws.on('connect', function () {
    clearInterval(_timer)
    _timer = setInterval(function () {
      let cmd    = getMotorCmd();
      let camera = getCameraCmd();
      if (cmd !== lastMotorCmd) {
        lastMotorCmd = cmd;
        ws.emit('motor', cmd || 'stop')
      }
      if (camera !== lastCameraCmd) {
        lastCameraCmd = camera;
        ws.emit('camera', camera || 'stop')
      }
    }, 20)
  })

  ws.on('car', function (car) {
    speed = sp.value = car.speed || 0;
  })

  ws.on('disconnect', function () {
    clearInterval(_timer);
    stop();
  })

  ws.on('error', function () {
    clearInterval(_timer);
    stop();
  })

  ws.on('message', function (data) {
    console.log(data);
  })

  document.body.addEventListener('keydown', function ({keyCode}) {
    switch (keyCode) {
      case 68:  //控制电机
      case 65:
      case 83:
      case 87:
      case 37:  //控制摄像头
      case 38:
      case 39:
      case 40:
        keyPress[keyCode] = true;
        break;
      case 189:
        speed -= 5
        speed < 0 && (speed = 0);
        sp.value = speed
        break;
      case 187:
        speed += 5
        speed > 100 && (speed = 100);
        sp.value = speed
        break;
      default:
        break;
    }
  }, true)
  document.body.addEventListener('keyup', function ({keyCode}) {
    switch (keyCode) {
      case 68:
      case 65:
      case 83:
      case 87:
      case 37:  //控制摄像头
      case 38:
      case 39:
      case 40:
        keyPress[keyCode] = false;
        break;
      case 32:
        stop();
        break;
      case 189:
      case 187:
        sp.value = speed
        ws.emit('motor', 'speed', speed)
        break;
      default:
        break;
    }
  })
</script>
</body>
</html>